# 3.4 `use()` Method

## Table of Contents
- [3.1 `cls()` Function](./3.1-cls-function.md)
- [3.2 `extend()` Method](./3.2-extend-method.md)
- [3.3 `contract()` Helper](./3.3-contract-helper.md)
- [3.4 `use()` Method](./3.4-use-method.md) *(current)*
- [3.5 `merge()` Utility](./3.5-merge-utility.md)
- [3.6 `tvc()` Helper](./3.6-tvc-helper.md)
- [3.7 What Utility](./3.7-what-utility.md)
- [3.8 Definition Helpers](./3.8-definition-helpers.md)
- [3.9 Override Helpers](./3.9-override-helpers.md)
- [3.10 Override System Deep Dive](./3.10-override-system-deep-dive.md)

---

The `use()` method is CLS's **composition mechanism** - it's how you combine multiple CLS instances together! Think of it as "mixins" or "composition over inheritance" in object-oriented programming, but for styling modules. Let's explore how it works! 🎯

## Method Signature 📋

```typescript
use<OtherCls extends Cls<any>>(
  otherCls: OtherCls
): Cls<MergedContract>
```

**Parameters:**
- `otherCls`: Another CLS instance to compose with

**Returns:** A new CLS instance that combines both modules

## Basic Composition 🚀

### Simple Composition Example

```typescript
import { cls, contract } from "@use-pico/cls";

// Base theme with colors
const ThemeCls = cls({
  tokens: {
    "color.bg": ["default", "primary", "danger"],
    "color.text": ["default", "primary", "danger"]
  },
  slot: ["root"],
  variant: {
    tone: ["default", "primary", "danger"]
  }
}, ({ what, def }) => ({
  token: def.token({
    "color.bg": {
      default: ["bg-gray-100"],
      primary: ["bg-blue-600"],
      danger: ["bg-red-500"]
    },
    "color.text": {
      default: ["text-gray-900"],
      primary: ["text-white"],
      danger: ["text-white"]
    }
  }),
  rules: [
    def.root({
      root: what.both(["inline-flex", "items-center", "rounded"], ["color.bg.default", "color.text.default"])
    })
  ],
  defaults: def.defaults({
    tone: "default"
  })
}));

// Interactive states module
const InteractiveCls = cls({
  tokens: {
    "interaction.state": ["hover", "focus", "active"]
  },
  slot: ["root"],
  variant: {
    disabled: ["bool"]
  }
}, ({ what, def }) => ({
  token: def.token({
    "interaction.state": {
      hover: ["hover:opacity-90"],
      focus: ["focus:ring-2", "focus:ring-blue-500"],
      active: ["active:scale-95"]
    }
  }),
  rules: [
    def.rule(
      what.variant({ disabled: true }),
      { root: what.css(["opacity-50", "cursor-not-allowed"]) }
    )
  ],
  defaults: def.defaults({
    disabled: false
  })
}));

// Compose theme and interactive states
const ButtonCls = ThemeCls.use(InteractiveCls);

// Now ButtonCls has both theme and interactive capabilities
const classes = ButtonCls.create(({ what }) => ({
  variant: what.variant({ 
    tone: "primary",  // From ThemeCls
    disabled: true    // From InteractiveCls
  })
}));
```

## How Composition Works 🔄

### Contract Merging

```typescript
// ThemeCls contract
const ThemeContract = contract({
  tokens: {
    "color.bg": ["default", "primary", "danger"]
  },
  slot: ["root"],
  variant: {
    tone: ["default", "primary", "danger"]
  }
});

// InteractiveCls contract
const InteractiveContract = contract({
  tokens: {
    "interaction.state": ["hover", "focus", "active"]
  },
  slot: ["root"],
  variant: {
    disabled: ["bool"]
  }
});

// Composed contract (automatic merging)
const ComposedContract = {
  tokens: {
    "color.bg": ["default", "primary", "danger"],        // From ThemeCls
    "interaction.state": ["hover", "focus", "active"]    // From InteractiveCls
  },
  slot: ["root"], // Merged slots
  variant: {
    tone: ["default", "primary", "danger"],              // From ThemeCls
    disabled: ["bool"]                                   // From InteractiveCls
  }
};
```

### Token Composition

```typescript
// ThemeCls tokens
const ThemeTokens = {
  "color.bg": {
    default: ["bg-gray-100"],
    primary: ["bg-blue-600"],
    danger: ["bg-red-500"]
  }
};

// InteractiveCls tokens
const InteractiveTokens = {
  "interaction.state": {
    hover: ["hover:opacity-90"],
    focus: ["focus:ring-2", "focus:ring-blue-500"],
    active: ["active:scale-95"]
  }
};

// Composed tokens (automatic merging)
const ComposedTokens = {
  "color.bg": {
    default: ["bg-gray-100"],
    primary: ["bg-blue-600"],
    danger: ["bg-red-500"]
  },
  "interaction.state": {
    hover: ["hover:opacity-90"],
    focus: ["focus:ring-2", "focus:ring-blue-500"],
    active: ["active:scale-95"]
  }
};
```

### Rule Composition

```typescript
// ThemeCls rules
const ThemeRules = [
  def.root({
    root: what.both(["inline-flex", "items-center", "rounded"], ["color.bg.default", "color.text.default"])
  }),
  def.rule(
    what.variant({ tone: "primary" }),
    { root: what.token(["color.bg.primary", "color.text.primary"]) }
  )
];

// InteractiveCls rules
const InteractiveRules = [
  def.rule(
    what.variant({ disabled: true }),
    { root: what.css(["opacity-50", "cursor-not-allowed"]) }
  )
];

// Composed rules (automatic merging)
const ComposedRules = [
  // All ThemeCls rules
  def.root({
    root: what.both(["inline-flex", "items-center", "rounded"], ["color.bg.default", "color.text.default"])
  }),
  def.rule(
    what.variant({ tone: "primary" }),
    { root: what.token(["color.bg.primary", "color.text.primary"]) }
  ),
  // All InteractiveCls rules
  def.rule(
    what.variant({ disabled: true }),
    { root: what.css(["opacity-50", "cursor-not-allowed"]) }
  )
];
```

## Multi-Module Composition 🏗️

### Complex Composition Example

```typescript
// Base theme
const ThemeCls = cls({
  tokens: {
    "color.bg": ["default", "primary", "danger"],
    "color.text": ["default", "primary", "danger"],
    "spacing.padding": ["sm", "md", "lg"]
  },
  variant: {
    tone: ["default", "primary", "danger"]
  }
}, ({ what, def }) => ({
  token: def.token({
    "color.bg": {
      default: ["bg-gray-100"],
      primary: ["bg-blue-600"],
      danger: ["bg-red-500"]
    },
    "spacing.padding": {
      sm: ["px-2", "py-1"],
      md: ["px-4", "py-2"],
      lg: ["px-6", "py-3"]
    }
  })
}));

// Interactive states
const InteractiveCls = cls({
  tokens: {
    "interaction.state": ["hover", "focus", "active"]
  },
  variant: {
    disabled: ["bool"]
  }
}, ({ what, def }) => ({
  token: def.token({
    "interaction.state": {
      hover: ["hover:opacity-90"],
      focus: ["focus:ring-2", "focus:ring-blue-500"],
      active: ["active:scale-95"]
    }
  }),
  rules: [
    def.rule(
      what.variant({ disabled: true }),
      { root: what.css(["opacity-50", "cursor-not-allowed"]) }
    )
  ]
}));

// Button-specific styling
const ButtonSpecificCls = cls({
  tokens: {
    "button.variant": ["solid", "outline", "ghost"]
  },
  slot: ["root", "label"],
  variant: {
    size: ["sm", "md", "lg"],
    variant: ["solid", "outline", "ghost"]
  }
}, ({ what, def }) => ({
  token: def.token({
    "button.variant": {
      solid: ["border-transparent"],
      outline: ["border", "bg-transparent"],
      ghost: ["bg-transparent"]
    }
  }),
  rules: [
    def.root({
      root: what.both(
        ["inline-flex", "items-center", "rounded", "font-medium"],
        ["color.bg.default", "spacing.padding.md"]
      ),
      label: what.css(["font-medium"])
    }),
    def.rule(
      what.variant({ variant: "outline" }),
      { root: what.css(["border-gray-300"]) }
    )
  ]
}));

// Compose all modules together
const ButtonCls = ThemeCls
  .use(InteractiveCls)
  .use(ButtonSpecificCls);

// Now ButtonCls has all capabilities from all modules
const classes = ButtonCls.create(({ what }) => ({
  variant: what.variant({ 
    tone: "primary",      // From ThemeCls
    disabled: false,      // From InteractiveCls
    size: "lg",           // From ButtonSpecificCls
    variant: "solid"      // From ButtonSpecificCls
  })
}));
```

## Composition vs Inheritance 🔄

### When to Use Composition (`use()`)

```typescript
// ✅ Good: Use composition for independent, reusable modules
const ThemeCls = cls(themeContract, themeDefinition);
const InteractiveCls = cls(interactiveContract, interactiveDefinition);
const AnimationCls = cls(animationContract, animationDefinition);

// Compose independent modules
const ButtonCls = ThemeCls.use(InteractiveCls).use(AnimationCls);
const CardCls = ThemeCls.use(AnimationCls);
const LinkCls = ThemeCls.use(InteractiveCls);
```

### When to Use Inheritance (`extend()`)

```typescript
// ✅ Good: Use inheritance for hierarchical relationships
const ThemeCls = cls(themeContract, themeDefinition);
const ComponentCls = ThemeCls.extend(componentContract, componentDefinition);
const ButtonCls = ComponentCls.extend(buttonContract, buttonDefinition);
```

### Combining Both

```typescript
// ✅ Good: Combine inheritance and composition
const ThemeCls = cls(themeContract, themeDefinition);
const InteractiveCls = cls(interactiveContract, interactiveDefinition);

// Inherit from theme, then compose with interactive
const ButtonCls = ThemeCls
  .extend(buttonContract, buttonDefinition)
  .use(InteractiveCls);
```

## Type Safety in Composition 🔒

### Automatic Type Inference

```typescript
const ThemeCls = cls({
  tokens: {
    "color.bg": ["default", "primary", "danger"]
  },
  variant: {
    tone: ["default", "primary", "danger"]
  }
}, themeDefinition);

const InteractiveCls = cls({
  tokens: {
    "interaction.state": ["hover", "focus", "active"]
  },
  variant: {
    disabled: ["bool"]
  }
}, interactiveDefinition);

const ComposedCls = ThemeCls.use(InteractiveCls);

// TypeScript knows about all tokens and variants from both modules
const classes = ComposedCls.create(({ what }) => ({
  variant: what.variant({ 
    tone: "primary",  // ✅ From ThemeCls
    disabled: true    // ✅ From InteractiveCls
  })
}));
```

### Type-Safe Token Usage

```typescript
const ComposedCls = ThemeCls.use(InteractiveCls);

// Can use tokens from both modules
const classes = ComposedCls.create(({ what }) => ({
  variant: what.variant({ tone: "primary", disabled: true }),
  // Can reference tokens from both modules
  root: what.both(
    what.token(["color.bg.primary"]),     // ✅ From ThemeCls
    what.token(["interaction.state.hover"]) // ✅ From InteractiveCls
  )
}));
```

## Performance Considerations ⚡

### Composition Chain Optimization

```typescript
// ✅ Good: CLS optimizes composition chains
const ThemeCls = cls(themeContract, themeDefinition);
const InteractiveCls = cls(interactiveContract, interactiveDefinition);
const ButtonCls = ThemeCls.use(InteractiveCls);

// CLS pre-computes the composition
// Token resolution is optimized for the composed modules
// No performance penalty for complex compositions

// ❌ Bad: Don't recreate composition chains
const getButtonClasses = () => {
  const ThemeCls = cls(themeContract, themeDefinition); // Recreated every time!
  const InteractiveCls = cls(interactiveContract, interactiveDefinition); // Recreated every time!
  const ButtonCls = ThemeCls.use(InteractiveCls); // Recreated every time!
  return ButtonCls.create(config);
};
```

## Best Practices 💡

### 1. **Create Reusable Modules**
```typescript
// ✅ Good: Create focused, reusable modules
const ThemeCls = cls(themeContract, themeDefinition);
const InteractiveCls = cls(interactiveContract, interactiveDefinition);
const AnimationCls = cls(animationContract, animationDefinition);

// Compose as needed
const ButtonCls = ThemeCls.use(InteractiveCls).use(AnimationCls);
const CardCls = ThemeCls.use(AnimationCls);
const LinkCls = ThemeCls.use(InteractiveCls);

// ❌ Bad: Don't create overly specific modules
const ButtonWithThemeAndInteractiveCls = cls(buttonContract, buttonDefinition);
```

### 2. **Use Composition for Independent Features**
```typescript
// ✅ Good: Compose independent features
const ThemeCls = cls(themeContract, themeDefinition);
const InteractiveCls = cls(interactiveContract, interactiveDefinition);
const AnimationCls = cls(animationContract, animationDefinition);

// Each module is independent and reusable
const ButtonCls = ThemeCls.use(InteractiveCls).use(AnimationCls);

// ❌ Bad: Don't compose tightly coupled modules
const ButtonThemeCls = cls(buttonThemeContract, buttonThemeDefinition);
const ButtonInteractiveCls = cls(buttonInteractiveContract, buttonInteractiveDefinition);
```

### 3. **Document Composition Relationships**
```typescript
// ✅ Good: Clear documentation of composition
/**
 * ButtonCls composes:
 * - ThemeCls: Provides colors, spacing, and tone variants
 * - InteractiveCls: Provides hover, focus, active states and disabled variant
 * - AnimationCls: Provides transition and animation tokens
 * 
 * Available tokens:
 * - color.bg.* (from ThemeCls)
 * - interaction.state.* (from InteractiveCls)
 * - animation.* (from AnimationCls)
 * 
 * Available variants:
 * - tone (from ThemeCls)
 * - disabled (from InteractiveCls)
 * - animated (from AnimationCls)
 */
const ButtonCls = ThemeCls.use(InteractiveCls).use(AnimationCls);
```

## The Bottom Line 💡

The `use()` method is CLS's **composition mechanism**:

- **Automatic merging**: Contracts, tokens, rules, and defaults are merged automatically
- **Type safe**: Full TypeScript support with composition-aware type inference
- **Performance optimized**: Composition chains are pre-computed and cached
- **Flexible**: Combine independent modules as needed
- **Reusable**: Create focused modules that can be composed in different ways

Think of `use()` as **"mixing ingredients"** - you combine different modules to create exactly what you need! 🎉

---

**Previous:** [3.3 `contract()` Helper](./3.3-contract-helper.md) | **Next:** [3.5 `merge()` Utility](./3.5-merge-utility.md)
