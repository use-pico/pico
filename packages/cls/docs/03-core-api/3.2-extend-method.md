# 3.2 `extend()` Method

## Table of Contents
- [3.1 `cls()` Function](./3.1-cls-function.md)
- [3.2 `extend()` Method](./3.2-extend-method.md) *(current)*
- [3.3 `contract()` Helper](./3.3-contract-helper.md)
- [3.4 `use()` Method](./3.4-use-method.md)
- [3.5 `merge()` Utility](./3.5-merge-utility.md)
- [3.6 `tvc()` Helper](./3.6-tvc-helper.md)
- [3.7 What Utility](./3.7-what-utility.md)
- [3.8 Definition Helpers](./3.8-definition-helpers.md)
- [3.9 Override Helpers](./3.9-override-helpers.md)
- [3.10 Override System Deep Dive](./3.10-override-system-deep-dive.md)

---

The `extend()` method is CLS's **inheritance mechanism** - it's how you build complex styling systems by extending simpler ones! Think of it as the "extends" keyword in object-oriented programming, but for styling modules. Let's explore how it works! 🎯

## Method Signature 📋

```typescript
extend<ChildContract extends Contract<any, any, any, any>>(
  childContract: ChildContract,
  childDefinitionFn: (props: WhatUtil<ChildContract>) => Definition<ChildContract>
): Cls<ChildContract>
```

**Parameters:**
- `childContract`: The contract for the new module (extends the parent)
- `childDefinitionFn`: A function that receives helper utilities and returns the child definition

**Returns:** A new CLS instance that inherits from the parent

## Basic Inheritance 🚀

### Simple Extension Example

```typescript
import { cls, contract } from "@use-pico/cls";

// Base theme with common tokens
const ThemeCls = cls({
  tokens: {
    "color.bg": ["default", "primary", "danger"],
    "color.text": ["default", "primary", "danger"],
    "spacing.padding": ["sm", "md", "lg"]
  },
  slot: ["root"],
  variant: {
    tone: ["default", "primary", "danger"]
  }
}, ({ what, def }) => ({
  token: def.token({
    "color.bg": {
      default: ["bg-gray-100"],
      primary: ["bg-blue-600"],
      danger: ["bg-red-500"]
    },
    "color.text": {
      default: ["text-gray-900"],
      primary: ["text-white"],
      danger: ["text-white"]
    },
    "spacing.padding": {
      sm: ["px-2", "py-1"],
      md: ["px-4", "py-2"],
      lg: ["px-6", "py-3"]
    }
  }),
  rules: [
    def.root({
      root: what.both(["inline-flex", "items-center", "rounded"], ["color.bg.default", "color.text.default", "spacing.padding.md"])
    })
  ],
  defaults: def.defaults({
    tone: "default"
  })
}));

// Extend theme to create a button
const ButtonCls = ThemeCls.extend({
  tokens: {
    // Inherit all theme tokens automatically
    "button.variant": ["solid", "outline", "ghost"]
  },
  slot: ["root", "label"], // Extend slots
  variant: {
    // Inherit all theme variants automatically
    size: ["sm", "md", "lg"], // Add button-specific variants
    variant: ["solid", "outline", "ghost"]
  }
}, ({ what, def }) => ({
  token: def.token({
    // All theme tokens are inherited automatically
    "button.variant": {
      solid: ["border-transparent"],
      outline: ["border", "bg-transparent"],
      ghost: ["bg-transparent", "hover:bg-gray-100"]
    }
  }),
  rules: [
    // All theme rules are inherited automatically
    def.rule(
      what.variant({ variant: "outline" }),
      { root: what.css(["border-gray-300"]) }
    ),
    def.rule(
      what.variant({ size: "lg" }),
      { root: what.token(["spacing.padding.lg"]) }
    )
  ],
  defaults: def.defaults({
    // All theme defaults are inherited automatically
    size: "md",
    variant: "solid"
  })
}));
```

## How Inheritance Works 🔄

### Automatic Token Inheritance

```typescript
// Parent has these tokens
const ThemeCls = cls({
  tokens: {
    "color.bg": ["default", "primary", "danger"],
    "color.text": ["default", "primary", "danger"]
  }
}, ({ what, def }) => ({
  token: def.token({
    "color.bg": {
      default: ["bg-gray-100"],
      primary: ["bg-blue-600"],
      danger: ["bg-red-500"]
    }
  })
}));

// Child automatically inherits all parent tokens
const ButtonCls = ThemeCls.extend({
  tokens: {
    // Only need to define new tokens
    "button.variant": ["solid", "outline"]
  }
}, ({ what, def }) => ({
  token: def.token({
    // Can use inherited tokens
    "button.variant": {
      solid: what.token(["color.bg.primary"]), // Uses inherited token
      outline: ["border", "border-gray-300"]
    }
  })
}));
```

### Automatic Rule Inheritance

```typescript
// Parent rules are automatically inherited
const ThemeCls = cls(themeContract, ({ what, def }) => ({
  rules: [
    def.root({
      root: what.css(["inline-flex", "items-center", "rounded"])
    }),
    def.rule(
      what.variant({ tone: "primary" }),
      { root: what.token(["color.bg.primary", "color.text.primary"]) }
    )
  ]
}));

// Child inherits all parent rules and adds its own
const ButtonCls = ThemeCls.extend(buttonContract, ({ what, def }) => ({
  rules: [
    // Parent rules are automatically included
    // Only need to add new rules
    def.rule(
      what.variant({ size: "lg" }),
      { root: what.token(["spacing.padding.lg"]) }
    )
  ]
}));
```

### Automatic Default Inheritance

```typescript
// Parent defaults
const ThemeCls = cls(themeContract, ({ what, def }) => ({
  defaults: def.defaults({
    tone: "default"
  })
}));

// Child inherits parent defaults and adds its own
const ButtonCls = ThemeCls.extend(buttonContract, ({ what, def }) => ({
  defaults: def.defaults({
    // Inherits: tone: "default"
    size: "md", // Adds new default
    variant: "solid" // Adds new default
  })
}));
```

## Contract Extension Rules 📋

### Token Inheritance

```typescript
// Parent contract
const ThemeContract = contract({
  tokens: {
    "color.bg": ["default", "primary", "danger"],
    "color.text": ["default", "primary", "danger"]
  }
});

// Child contract - tokens are merged
const ButtonContract = contract({
  tokens: {
    // Inherit all parent tokens automatically
    "button.variant": ["solid", "outline"] // Add new tokens
  }
});

// Result: ButtonCls has tokens:
// - "color.bg": ["default", "primary", "danger"] (inherited)
// - "color.text": ["default", "primary", "danger"] (inherited)
// - "button.variant": ["solid", "outline"] (new)
```

### Slot Inheritance

```typescript
// Parent contract
const ThemeContract = {
  slot: ["root"]
};

// Child contract - slots are extended
const ButtonContract = {
  slot: ["root", "label"] // Add new slots
};

// Result: ButtonCls has slots:
// - "root" (inherited)
// - "label" (new)
```

### Variant Inheritance

```typescript
// Parent contract
const ThemeContract = {
  variant: {
    tone: ["default", "primary", "danger"]
  }
};

// Child contract - variants are merged
const ButtonContract = {
  variant: {
    // Inherit all parent variants automatically
    size: ["sm", "md", "lg"], // Add new variants
    variant: ["solid", "outline"]
  }
};

// Result: ButtonCls has variants:
// - tone: ["default", "primary", "danger"] (inherited)
// - size: ["sm", "md", "lg"] (new)
// - variant: ["solid", "outline"] (new)
```

## Multi-Level Inheritance 🏗️

### Building Complex Hierarchies

```typescript
// Level 1: Base theme
const ThemeCls = cls(themeContract, themeDefinition);

// Level 2: Component base
const ComponentCls = ThemeCls.extend(componentContract, componentDefinition);

// Level 3: Specific component
const ButtonCls = ComponentCls.extend(buttonContract, buttonDefinition);

// Level 4: Button variant
const PrimaryButtonCls = ButtonCls.extend(primaryButtonContract, primaryButtonDefinition);

// Usage: Each level inherits from all previous levels
const classes = PrimaryButtonCls.create(({ what }) => ({
  variant: what.variant({ 
    // Has access to all variants from all levels
    tone: "primary", // From ThemeCls
    size: "lg",      // From ComponentCls
    variant: "solid" // From ButtonCls
  })
}));
```

### Inheritance Chain Example

```typescript
// Base theme with colors and spacing
const ThemeCls = cls({
  tokens: {
    "color.bg": ["default", "primary", "danger"],
    "spacing.padding": ["sm", "md", "lg"]
  },
  variant: {
    tone: ["default", "primary", "danger"]
  }
}, ({ what, def }) => ({
  token: def.token({
    "color.bg": {
      default: ["bg-gray-100"],
      primary: ["bg-blue-600"],
      danger: ["bg-red-500"]
    }
  })
}));

// Interactive elements (buttons, links, etc.)
const InteractiveCls = ThemeCls.extend({
  tokens: {
    "interaction.state": ["hover", "focus", "active"]
  },
  variant: {
    disabled: ["bool"]
  }
}, ({ what, def }) => ({
  token: def.token({
    "interaction.state": {
      hover: ["hover:opacity-90"],
      focus: ["focus:ring-2", "focus:ring-blue-500"],
      active: ["active:scale-95"]
    }
  }),
  rules: [
    def.rule(
      what.variant({ disabled: true }),
      { root: what.css(["opacity-50", "cursor-not-allowed"]) }
    )
  ]
}));

// Button-specific styling
const ButtonCls = InteractiveCls.extend({
  tokens: {
    "button.variant": ["solid", "outline", "ghost"]
  },
  slot: ["root", "label"],
  variant: {
    size: ["sm", "md", "lg"],
    variant: ["solid", "outline", "ghost"]
  }
}, ({ what, def }) => ({
  token: def.token({
    "button.variant": {
      solid: ["border-transparent"],
      outline: ["border", "bg-transparent"],
      ghost: ["bg-transparent"]
    }
  }),
  rules: [
    def.root({
      root: what.both(
        ["inline-flex", "items-center", "rounded", "font-medium"],
        ["color.bg.default", "spacing.padding.md"]
      ),
      label: what.css(["font-medium"])
    })
  ]
}));
```

## Type Safety in Inheritance 🔒

### Automatic Type Inference

```typescript
const ThemeCls = cls({
  tokens: {
    "color.bg": ["default", "primary", "danger"]
  },
  variant: {
    tone: ["default", "primary", "danger"]
  }
}, ({ what, def }) => ({
  // Implementation
}));

const ButtonCls = ThemeCls.extend({
  tokens: {
    "button.variant": ["solid", "outline"]
  },
  variant: {
    size: ["sm", "md", "lg"],
    variant: ["solid", "outline"]
  }
}, ({ what, def }) => ({
  // TypeScript knows about:
  // - Inherited tokens: "color.bg.default", "color.bg.primary", "color.bg.danger"
  // - Inherited variants: tone: "default" | "primary" | "danger"
  // - New tokens: "button.variant.solid", "button.variant.outline"
  // - New variants: size: "sm" | "md" | "lg", variant: "solid" | "outline"
}));
```

### Type-Safe Token Usage

```typescript
const ButtonCls = ThemeCls.extend(buttonContract, ({ what, def }) => ({
  token: def.token({
    "button.variant": {
      solid: what.token(["color.bg.primary"]), // ✅ TypeScript knows this token exists
      outline: what.token(["color.bg.default"]) // ✅ TypeScript knows this token exists
    }
  }),
  rules: [
    def.rule(
      what.variant({ 
        tone: "primary", // ✅ TypeScript knows this variant exists
        size: "lg"       // ✅ TypeScript knows this variant exists
      }),
      { root: what.token(["color.bg.primary"]) }
    )
  ]
}));
```

## Performance Considerations ⚡

### Inheritance Chain Optimization

```typescript
// ✅ Good: CLS optimizes inheritance chains
const ThemeCls = cls(themeContract, themeDefinition);
const ButtonCls = ThemeCls.extend(buttonContract, buttonDefinition);

// CLS pre-computes the inheritance chain
// Token resolution is optimized for the full chain
// No performance penalty for deep inheritance

// ❌ Bad: Don't recreate inheritance chains
const getButtonClasses = () => {
  const ThemeCls = cls(themeContract, themeDefinition); // Recreated every time!
  const ButtonCls = ThemeCls.extend(buttonContract, buttonDefinition); // Recreated every time!
  return ButtonCls.create(config);
};
```

## Best Practices 💡

### 1. **Build from Base Themes**
```typescript
// ✅ Good: Start with comprehensive base themes
const ThemeCls = cls(themeContract, themeDefinition);
const ComponentCls = ThemeCls.extend(componentContract, componentDefinition);
const ButtonCls = ComponentCls.extend(buttonContract, buttonDefinition);

// ❌ Bad: Don't extend from overly specific bases
const SpecificButtonCls = cls(specificButtonContract, specificButtonDefinition);
const OtherButtonCls = SpecificButtonCls.extend(otherButtonContract, otherButtonDefinition);
```

### 2. **Keep Inheritance Chains Reasonable**
```typescript
// ✅ Good: Reasonable inheritance depth
const ThemeCls = cls(themeContract, themeDefinition);
const InteractiveCls = ThemeCls.extend(interactiveContract, interactiveDefinition);
const ButtonCls = InteractiveCls.extend(buttonContract, buttonDefinition);

// ❌ Bad: Too deep inheritance chains
const Level1 = cls(contract1, definition1);
const Level2 = Level1.extend(contract2, definition2);
const Level3 = Level2.extend(contract3, definition3);
const Level4 = Level3.extend(contract4, definition4);
const Level5 = Level4.extend(contract5, definition5);
// ... and so on
```

### 3. **Document Inheritance Relationships**
```typescript
// ✅ Good: Clear documentation of inheritance
/**
 * ButtonCls extends InteractiveCls which extends ThemeCls
 * 
 * Inherits:
 * - Theme tokens: color.bg, color.text, spacing.padding
 * - Theme variants: tone
 * - Interactive tokens: interaction.state
 * - Interactive variants: disabled
 * 
 * Adds:
 * - Button tokens: button.variant
 * - Button variants: size, variant
 * - Button slots: root, label
 */
const ButtonCls = InteractiveCls.extend(buttonContract, buttonDefinition);
```

## The Bottom Line 💡

The `extend()` method is CLS's **inheritance mechanism**:

- **Automatic inheritance**: Tokens, rules, and defaults are inherited automatically
- **Type safe**: Full TypeScript support with inheritance-aware type inference
- **Performance optimized**: Inheritance chains are pre-computed and cached
- **Flexible**: Build complex systems from simple bases
- **Clear relationships**: Explicit parent-child relationships

Think of `extend()` as **"building a family tree"** - each level extends and builds upon the previous one! 🎉

---

**Previous:** [3.1 `cls()` Function](./3.1-cls-function.md) | **Next:** [3.3 `contract()` Helper](./3.3-contract-helper.md)
