# 3.5 `merge()` Utility

## Table of Contents
- [3.1 `cls()` Function](./3.1-cls-function.md)
- [3.2 `extend()` Method](./3.2-extend-method.md)
- [3.3 `contract()` Helper](./3.3-contract-helper.md)
- [3.4 `use()` Method](./3.4-use-method.md)
- [3.5 `merge()` Utility](./3.5-merge-utility.md) *(current)*
- [3.6 `tvc()` Helper](./3.6-tvc-helper.md)
- [3.7 What Utility](./3.7-what-utility.md)
- [3.8 Definition Helpers](./3.8-definition-helpers.md)
- [3.9 Override Helpers](./3.9-override-helpers.md)
- [3.10 Override System Deep Dive](./3.10-override-system-deep-dive.md)

---

The `merge()` utility is CLS's **manual composition tool** - it's how you combine multiple CLS instances or configurations at runtime! Think of it as a "manual mixer" that lets you combine different styling modules when you need more control than the automatic `use()` method provides. Let's explore how it works! 🎯

## Function Signature 📋

```typescript
function merge<T extends Cls<any>[]>(
  ...clsInstances: T
): Cls<MergedContract>
```

**Parameters:**
- `...clsInstances`: Multiple CLS instances to merge together

**Returns:** A new CLS instance that combines all input instances

## Basic Merging 🚀

### Simple Merge Example

```typescript
import { cls, merge } from "@use-pico/cls";

// Theme module
const ThemeCls = cls({
  tokens: {
    "color.bg": ["default", "primary", "danger"],
    "color.text": ["default", "primary", "danger"]
  },
  slot: ["root"],
  variant: {
    tone: ["default", "primary", "danger"]
  }
}, ({ what, def }) => ({
  token: def.token({
    "color.bg": {
      default: ["bg-gray-100"],
      primary: ["bg-blue-600"],
      danger: ["bg-red-500"]
    },
    "color.text": {
      default: ["text-gray-900"],
      primary: ["text-white"],
      danger: ["text-white"]
    }
  }),
  rules: [
    def.root({
      root: what.both(["inline-flex", "items-center", "rounded"], ["color.bg.default", "color.text.default"])
    })
  ],
  defaults: def.defaults({
    tone: "default"
  })
}));

// Interactive module
const InteractiveCls = cls({
  tokens: {
    "interaction.state": ["hover", "focus", "active"]
  },
  slot: ["root"],
  variant: {
    disabled: ["bool"]
  }
}, ({ what, def }) => ({
  token: def.token({
    "interaction.state": {
      hover: ["hover:opacity-90"],
      focus: ["focus:ring-2", "focus:ring-blue-500"],
      active: ["active:scale-95"]
    }
  }),
  rules: [
    def.rule(
      what.variant({ disabled: true }),
      { root: what.css(["opacity-50", "cursor-not-allowed"]) }
    )
  ],
  defaults: def.defaults({
    disabled: false
  })
}));

// Manual merge of multiple modules
const ButtonCls = merge(ThemeCls, InteractiveCls);

// Now ButtonCls has both theme and interactive capabilities
const classes = ButtonCls.create(({ what }) => ({
  variant: what.variant({ 
    tone: "primary",  // From ThemeCls
    disabled: true    // From InteractiveCls
  })
}));
```

## Merge vs Use Comparison 🔄

### Using `use()` Method (Automatic)

```typescript
// ✅ Automatic composition with use()
const ButtonCls = ThemeCls.use(InteractiveCls);

// Simple and clean, but less control
```

### Using `merge()` Utility (Manual)

```typescript
// ✅ Manual composition with merge()
const ButtonCls = merge(ThemeCls, InteractiveCls);

// More explicit, gives you control over the merge order
```

### When to Use Each

```typescript
// ✅ Use merge() when you need control over merge order
const ButtonCls = merge(
  ThemeCls,        // Base theme (merged first)
  InteractiveCls,  // Interactive states (merged second)
  AnimationCls     // Animations (merged last, can override previous)
);

// ✅ Use use() for simple composition
const SimpleButtonCls = ThemeCls.use(InteractiveCls);
```

## Multi-Module Merging 🏗️

### Complex Merge Example

```typescript
// Base theme
const ThemeCls = cls({
  tokens: {
    "color.bg": ["default", "primary", "danger"],
    "color.text": ["default", "primary", "danger"],
    "spacing.padding": ["sm", "md", "lg"]
  },
  variant: {
    tone: ["default", "primary", "danger"]
  }
}, ({ what, def }) => ({
  token: def.token({
    "color.bg": {
      default: ["bg-gray-100"],
      primary: ["bg-blue-600"],
      danger: ["bg-red-500"]
    },
    "spacing.padding": {
      sm: ["px-2", "py-1"],
      md: ["px-4", "py-2"],
      lg: ["px-6", "py-3"]
    }
  })
}));

// Interactive states
const InteractiveCls = cls({
  tokens: {
    "interaction.state": ["hover", "focus", "active"]
  },
  variant: {
    disabled: ["bool"]
  }
}, ({ what, def }) => ({
  token: def.token({
    "interaction.state": {
      hover: ["hover:opacity-90"],
      focus: ["focus:ring-2", "focus:ring-blue-500"],
      active: ["active:scale-95"]
    }
  }),
  rules: [
    def.rule(
      what.variant({ disabled: true }),
      { root: what.css(["opacity-50", "cursor-not-allowed"]) }
    )
  ]
}));

// Animation module
const AnimationCls = cls({
  tokens: {
    "animation.transition": ["fast", "normal", "slow"]
  },
  variant: {
    animated: ["bool"]
  }
}, ({ what, def }) => ({
  token: def.token({
    "animation.transition": {
      fast: ["transition-all", "duration-150"],
      normal: ["transition-all", "duration-300"],
      slow: ["transition-all", "duration-500"]
    }
  }),
  rules: [
    def.rule(
      what.variant({ animated: true }),
      { root: what.token(["animation.transition.normal"]) }
    )
  ]
}));

// Button-specific styling
const ButtonSpecificCls = cls({
  tokens: {
    "button.variant": ["solid", "outline", "ghost"]
  },
  slot: ["root", "label"],
  variant: {
    size: ["sm", "md", "lg"],
    variant: ["solid", "outline", "ghost"]
  }
}, ({ what, def }) => ({
  token: def.token({
    "button.variant": {
      solid: ["border-transparent"],
      outline: ["border", "bg-transparent"],
      ghost: ["bg-transparent"]
    }
  }),
  rules: [
    def.root({
      root: what.both(
        ["inline-flex", "items-center", "rounded", "font-medium"],
        ["color.bg.default", "spacing.padding.md"]
      ),
      label: what.css(["font-medium"])
    })
  ]
}));

// Manual merge with specific order
const ButtonCls = merge(
  ThemeCls,           // Base theme (foundation)
  InteractiveCls,     // Interactive states
  AnimationCls,       // Animations
  ButtonSpecificCls   // Button-specific styling (can override previous)
);

// Now ButtonCls has all capabilities from all modules
const classes = ButtonCls.create(({ what }) => ({
  variant: what.variant({ 
    tone: "primary",      // From ThemeCls
    disabled: false,      // From InteractiveCls
    animated: true,       // From AnimationCls
    size: "lg",           // From ButtonSpecificCls
    variant: "solid"      // From ButtonSpecificCls
  })
}));
```

## Merge Order and Precedence 📋

### Later Modules Override Earlier Ones

```typescript
// Module A: Basic styling
const ModuleACls = cls({
  tokens: {
    "color.bg": ["default", "primary"]
  }
}, ({ what, def }) => ({
  token: def.token({
    "color.bg": {
      default: ["bg-gray-100"],
      primary: ["bg-blue-600"]
    }
  })
}));

// Module B: Overrides primary color
const ModuleBCls = cls({
  tokens: {
    "color.bg": ["default", "primary"]
  }
}, ({ what, def }) => ({
  token: def.token({
    "color.bg": {
      default: ["bg-gray-100"],
      primary: ["bg-green-600"] // Overrides ModuleA's blue
    }
  })
}));

// Merge order matters
const MergedCls1 = merge(ModuleACls, ModuleBCls);
// Result: primary = "bg-green-600" (ModuleB wins)

const MergedCls2 = merge(ModuleBCls, ModuleACls);
// Result: primary = "bg-blue-600" (ModuleA wins)
```

### Rule Precedence

```typescript
// Module A: Basic rule
const ModuleACls = cls({
  variant: {
    size: ["sm", "md", "lg"]
  }
}, ({ what, def }) => ({
  rules: [
    def.rule(
      what.variant({ size: "lg" }),
      { root: what.css(["text-lg"]) }
    )
  ]
}));

// Module B: Override rule
const ModuleBCls = cls({
  variant: {
    size: ["sm", "md", "lg"]
  }
}, ({ what, def }) => ({
  rules: [
    def.rule(
      what.variant({ size: "lg" }),
      { root: what.css(["text-xl"]) } // Overrides ModuleA's text-lg
    )
  ]
}));

// Later rules override earlier ones
const MergedCls = merge(ModuleACls, ModuleBCls);
// Result: size="lg" applies text-xl (ModuleB wins)
```

## Type Safety in Merging 🔒

### Automatic Type Inference

```typescript
const ThemeCls = cls({
  tokens: {
    "color.bg": ["default", "primary", "danger"]
  },
  variant: {
    tone: ["default", "primary", "danger"]
  }
}, themeDefinition);

const InteractiveCls = cls({
  tokens: {
    "interaction.state": ["hover", "focus", "active"]
  },
  variant: {
    disabled: ["bool"]
  }
}, interactiveDefinition);

const MergedCls = merge(ThemeCls, InteractiveCls);

// TypeScript knows about all tokens and variants from both modules
const classes = MergedCls.create(({ what }) => ({
  variant: what.variant({ 
    tone: "primary",  // ✅ From ThemeCls
    disabled: true    // ✅ From InteractiveCls
  })
}));
```

### Type-Safe Token Usage

```typescript
const MergedCls = merge(ThemeCls, InteractiveCls);

// Can use tokens from both modules
const classes = MergedCls.create(({ what }) => ({
  variant: what.variant({ tone: "primary", disabled: true }),
  // Can reference tokens from both modules
  root: what.both(
    what.token(["color.bg.primary"]),     // ✅ From ThemeCls
    what.token(["interaction.state.hover"]) // ✅ From InteractiveCls
  )
}));
```

## Performance Considerations ⚡

### Merge Optimization

```typescript
// ✅ Good: CLS optimizes merge operations
const ThemeCls = cls(themeContract, themeDefinition);
const InteractiveCls = cls(interactiveContract, interactiveDefinition);
const ButtonCls = merge(ThemeCls, InteractiveCls);

// CLS pre-computes the merge
// Token resolution is optimized for the merged modules
// No performance penalty for complex merges

// ❌ Bad: Don't recreate merge operations
const getButtonClasses = () => {
  const ThemeCls = cls(themeContract, themeDefinition); // Recreated every time!
  const InteractiveCls = cls(interactiveContract, interactiveDefinition); // Recreated every time!
  const ButtonCls = merge(ThemeCls, InteractiveCls); // Recreated every time!
  return ButtonCls.create(config);
};
```

## Best Practices 💡

### 1. **Use Merge for Explicit Control**
```typescript
// ✅ Good: Use merge when you need control over order
const ButtonCls = merge(
  ThemeCls,        // Base (merged first)
  InteractiveCls,  // States (merged second)
  AnimationCls     // Animations (merged last, can override)
);

// ❌ Bad: Don't use merge for simple cases
const SimpleCls = merge(ThemeCls, InteractiveCls); // use() would be simpler
```

### 2. **Document Merge Order**
```typescript
// ✅ Good: Clear documentation of merge order
/**
 * ButtonCls merges modules in this order:
 * 1. ThemeCls: Base colors, spacing, and tone variants
 * 2. InteractiveCls: Hover, focus, active states and disabled variant
 * 3. AnimationCls: Transition and animation tokens
 * 4. ButtonSpecificCls: Button-specific styling (can override previous)
 * 
 * Later modules can override tokens and rules from earlier modules.
 */
const ButtonCls = merge(ThemeCls, InteractiveCls, AnimationCls, ButtonSpecificCls);
```

### 3. **Use Merge for Conditional Composition**
```typescript
// ✅ Good: Use merge for conditional module composition
const baseModules = [ThemeCls, InteractiveCls];
const optionalModules = [];

if (hasAnimations) {
  optionalModules.push(AnimationCls);
}

if (hasCustomStyling) {
  optionalModules.push(CustomStylingCls);
}

const ButtonCls = merge(...baseModules, ...optionalModules);
```

### 4. **Avoid Over-Merging**
```typescript
// ✅ Good: Reasonable number of modules
const ButtonCls = merge(ThemeCls, InteractiveCls, AnimationCls);

// ❌ Bad: Too many modules make it hard to understand
const ButtonCls = merge(
  ThemeCls, InteractiveCls, AnimationCls, 
  CustomStylingCls, ExperimentalCls, LegacyCls,
  AccessibilityCls, PerformanceCls, DebugCls
);
```

## The Bottom Line 💡

The `merge()` utility is CLS's **manual composition tool**:

- **Explicit control**: You control the merge order and precedence
- **Type safe**: Full TypeScript support with merge-aware type inference
- **Performance optimized**: Merge operations are pre-computed and cached
- **Flexible**: Combine any number of modules in any order
- **Override support**: Later modules can override earlier ones

Think of `merge()` as **"manual mixing"** - you have full control over how your modules are combined! 🎉

---

**Previous:** [3.4 `use()` Method](./3.4-use-method.md) | **Next:** [3.6 `tvc()` Helper](./3.6-tvc-helper.md)
