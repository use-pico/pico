# 14.2 From CVA to CLS

## Table of Contents
- [14.1 Migration Overview](./14.1-migration-overview.md)
- [14.2 From CVA to CLS](./14.2-from-cva-to-cls.md) *(current)*
- [14.3 From TV to CLS](./14.3-from-tv-to-cls.md)
- [14.4 From Stitches to CLS](./14.4-from-stitches-to-cls.md)
- [14.5 From Vanilla Extract to CLS](./14.5-from-vanilla-extract-to-cls.md)
- [14.6 From CSS Modules to CLS](./14.6-from-css-modules-to-cls.md)
- [14.7 From Emotion to CLS](./14.7-from-emotion-to-cls.md)
- [14.8 Migration Best Practices](./14.8-migration-best-practices.md)

---

This guide provides **step-by-step instructions** for migrating from **Class Variance Authority (CVA)** to CLS. CVA is a popular variant-based styling library, and this migration will help you unlock CLS's **advanced features** like inheritance, design tokens, and runtime flexibility.

## **Migration Overview** üìä

### **Complexity**: üü° Medium (2-4 weeks)
### **Key Benefits**: 
- **Multi-level inheritance** instead of composition
- **Design token system** for organized values
- **Runtime flexibility** with token overrides
- **Enhanced type safety** with contract validation

## **Before & After Comparison** üîÑ

### **CVA Implementation** üéØ

```typescript
import { cva, type VariantProps } from "class-variance-authority";

const button = cva(
  "inline-flex items-center justify-center rounded font-medium transition-colors",
  {
    variants: {
      size: {
        sm: "px-3 py-1.5 text-sm",
        md: "px-4 py-2 text-base",
        lg: "px-6 py-3 text-lg",
      },
      tone: {
        primary: "bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500",
        secondary: "bg-gray-600 text-white hover:bg-gray-700 focus:ring-gray-500",
        danger: "bg-red-600 text-white hover:bg-red-700 focus:ring-red-500",
      },
      disabled: {
        true: "opacity-50 cursor-not-allowed",
        false: "cursor-pointer",
      },
    },
    defaultVariants: {
      size: "md",
      tone: "primary",
      disabled: false,
    },
  }
);

interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof button> {
  children: React.ReactNode;
}

function Button({ children, size, tone, disabled, className, ...props }: ButtonProps) {
  return (
    <button className={button({ size, tone, disabled, className })} {...props}>
      {children}
    </button>
  );
}
```

### **CLS Implementation** ‚ú®

```typescript
import { cls } from "@use-pico/cls";
import { useCls } from "@use-pico/cls/react";
import type { Component } from "@use-pico/cls";

// Define the CLS instance
const ButtonCls = cls({
  slot: ["root"],
  variant: {
    size: ["sm", "md", "lg"],
    tone: ["primary", "secondary", "danger"],
    disabled: [true, false]
  }
}, ({ what, def }) => ({
  token: def.token({
    "color.bg.primary": ["bg-blue-600"],
    "color.bg.primary.hover": ["hover:bg-blue-700"],
    "color.bg.secondary": ["bg-gray-600"],
    "color.bg.secondary.hover": ["hover:bg-gray-700"],
    "color.bg.danger": ["bg-red-600"],
    "color.bg.danger.hover": ["hover:bg-red-700"],
    "color.text.primary": ["text-white"],
    "color.text.secondary": ["text-white"],
    "color.text.danger": ["text-white"],
    "spacing.sm": ["px-3 py-1.5"],
    "spacing.md": ["px-4 py-2"],
    "spacing.lg": ["px-6 py-3"]
  }),
  rules: [
    def.root({
      root: what.css([
        "inline-flex items-center justify-center rounded font-medium transition-colors"
      ])
    }),
    def.rule({
      variant: { size: "sm" },
      root: what.css(["text-sm", "spacing.sm"])
    }),
    def.rule({
      variant: { size: "md" },
      root: what.css(["text-base", "spacing.md"])
    }),
    def.rule({
      variant: { size: "lg" },
      root: what.css(["text-lg", "spacing.lg"])
    }),
    def.rule({
      variant: { tone: "primary" },
      root: what.css([
        "color.bg.primary",
        "color.bg.primary.hover",
        "color.text.primary",
        "focus:ring-blue-500"
      ])
    }),
    def.rule({
      variant: { tone: "secondary" },
      root: what.css([
        "color.bg.secondary",
        "color.bg.secondary.hover",
        "color.text.secondary",
        "focus:ring-gray-500"
      ])
    }),
    def.rule({
      variant: { tone: "danger" },
      root: what.css([
        "color.bg.danger",
        "color.bg.danger.hover",
        "color.text.danger",
        "focus:ring-red-500"
      ])
    }),
    def.rule({
      variant: { disabled: true },
      root: what.css(["opacity-50", "cursor-not-allowed"])
    }),
    def.rule({
      variant: { disabled: false },
      root: what.css(["cursor-pointer"])
    })
  ],
  defaults: def.defaults({
    size: "md",
    tone: "primary",
    disabled: false
  })
}));

// React component
interface ButtonProps extends Component<typeof ButtonCls, React.ButtonHTMLAttributes<HTMLButtonElement>> {
  children: React.ReactNode;
  size?: "sm" | "md" | "lg";
  tone?: "primary" | "secondary" | "danger";
  disabled?: boolean;
}

function Button({
  children,
  size = "md",
  tone = "primary",
  disabled = false,
  tva = ButtonCls,
  cls,
  ...props
}: ButtonProps) {
  const buttonClasses = useCls(tva, cls, ({ what }) => ({
    variant: what.variant({
      size,
      tone,
      disabled
    })
  }));

  return (
    <button className={buttonClasses.root()} {...props}>
      {children}
    </button>
  );
}
```

## **Step-by-Step Migration Guide** üõ§Ô∏è

### **Step 1: Install CLS** üì¶

```bash
# Remove CVA
npm uninstall class-variance-authority

# Install CLS
npm install @use-pico/cls

# For React integration
npm install @use-pico/cls
```

### **Step 2: Understand the Differences** üîç

| CVA Concept | CLS Equivalent | Notes |
|-------------|----------------|-------|
| `cva()` function | `cls()` function | Core styling function |
| `variants` object | `variant` in contract | Define available variants |
| `defaultVariants` | `defaults` in definition | Set default values |
| `VariantProps<T>` | `Component<T>` | Type-safe component props |
| `className` prop | `cls` prop | User configuration |
| Composition | Inheritance + Composition | More powerful composition |

### **Step 3: Convert CVA Variants to CLS Contract** üìã

**CVA Variants:**
```typescript
const button = cva("base-classes", {
  variants: {
    size: {
      sm: "px-3 py-1.5 text-sm",
      md: "px-4 py-2 text-base",
      lg: "px-6 py-3 text-lg",
    },
    tone: {
      primary: "bg-blue-600 text-white",
      secondary: "bg-gray-600 text-white",
      danger: "bg-red-600 text-white",
    },
  },
  defaultVariants: {
    size: "md",
    tone: "primary",
  },
});
```

**CLS Contract:**
```typescript
const ButtonCls = cls({
  slot: ["root"],
  variant: {
    size: ["sm", "md", "lg"],
    tone: ["primary", "secondary", "danger"]
  }
}, ({ what, def }) => ({
  // Definition goes here...
}));
```

### **Step 4: Extract Design Tokens** üé®

**Before (Hardcoded in CVA):**
```typescript
const button = cva("base-classes", {
  variants: {
    size: {
      sm: "px-3 py-1.5 text-sm", // Hardcoded values
      md: "px-4 py-2 text-base", // Hardcoded values
      lg: "px-6 py-3 text-lg",   // Hardcoded values
    },
    tone: {
      primary: "bg-blue-600 text-white",   // Hardcoded values
      secondary: "bg-gray-600 text-white", // Hardcoded values
      danger: "bg-red-600 text-white",     // Hardcoded values
    },
  },
});
```

**After (Design Tokens in CLS):**
```typescript
const ButtonCls = cls({
  slot: ["root"],
  variant: {
    size: ["sm", "md", "lg"],
    tone: ["primary", "secondary", "danger"]
  }
}, ({ what, def }) => ({
  token: def.token({
    "color.bg.primary": ["bg-blue-600"],
    "color.bg.secondary": ["bg-gray-600"],
    "color.bg.danger": ["bg-red-600"],
    "color.text.primary": ["text-white"],
    "color.text.secondary": ["text-white"],
    "color.text.danger": ["text-white"],
    "spacing.sm": ["px-3 py-1.5"],
    "spacing.md": ["px-4 py-2"],
    "spacing.lg": ["px-6 py-3"]
  }),
  // Rules use tokens instead of hardcoded values
}));
```

### **Step 5: Convert Variants to Rules** üìù

**CVA Variants:**
```typescript
variants: {
  size: {
    sm: "px-3 py-1.5 text-sm",
    md: "px-4 py-2 text-base",
    lg: "px-6 py-3 text-lg",
  },
  tone: {
    primary: "bg-blue-600 text-white",
    secondary: "bg-gray-600 text-white",
    danger: "bg-red-600 text-white",
  },
}
```

**CLS Rules:**
```typescript
rules: [
  def.rule({
    variant: { size: "sm" },
    root: what.css(["text-sm", "spacing.sm"])
  }),
  def.rule({
    variant: { size: "md" },
    root: what.css(["text-base", "spacing.md"])
  }),
  def.rule({
    variant: { size: "lg" },
    root: what.css(["text-lg", "spacing.lg"])
  }),
  def.rule({
    variant: { tone: "primary" },
    root: what.css(["color.bg.primary", "color.text.primary"])
  }),
  def.rule({
    variant: { tone: "secondary" },
    root: what.css(["color.bg.secondary", "color.text.secondary"])
  }),
  def.rule({
    variant: { tone: "danger" },
    root: what.css(["color.bg.danger", "color.text.danger"])
  })
]
```

### **Step 6: Update Component Interface** üß©

**CVA Component:**
```typescript
interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof button> {
  children: React.ReactNode;
}

function Button({ children, size, tone, className, ...props }: ButtonProps) {
  return (
    <button className={button({ size, tone, className })} {...props}>
      {children}
    </button>
  );
}
```

**CLS Component:**
```typescript
import type { Component } from "@use-pico/cls";

interface ButtonProps extends Component<typeof ButtonCls, React.ButtonHTMLAttributes<HTMLButtonElement>> {
  children: React.ReactNode;
  size?: "sm" | "md" | "lg";
  tone?: "primary" | "secondary" | "danger";
}

function Button({
  children,
  size = "md",
  tone = "primary",
  tva = ButtonCls,
  cls,
  ...props
}: ButtonProps) {
  const buttonClasses = useCls(tva, cls, ({ what }) => ({
    variant: what.variant({ size, tone })
  }));

  return (
    <button className={buttonClasses.root()} {...props}>
      {children}
    </button>
  );
}
```

### **Step 7: Handle Compound Variants** üîó

**CVA Compound Variants:**
```typescript
const button = cva("base-classes", {
  variants: { sm: "text-sm", md: "text-base", lg: "text-lg" },
  tone: { primary: "bg-blue-600", secondary: "bg-gray-600" }
}, {
  compoundVariants: [
    {
      size: "sm",
      tone: "primary",
      class: "px-2 py-1" // Special spacing for small primary
    }
  ]
});
```

**CLS Compound Rules:**
```typescript
rules: [
  // Individual variant rules
  def.rule({
    variant: { size: "sm" },
    root: what.css(["text-sm"])
  }),
  def.rule({
    variant: { tone: "primary" },
    root: what.css(["color.bg.primary"])
  }),
  // Compound rule (more specific)
  def.rule({
    variant: { size: "sm", tone: "primary" },
    root: what.css(["px-2 py-1"]) // Overrides default spacing
  })
]
```

### **Step 8: Implement Inheritance** üèóÔ∏è

**CVA (No Inheritance):**
```typescript
// Each button type is separate
const baseButton = cva("base-classes", {
  variants: { size: { sm: "text-sm", md: "text-base" } }
});

const primaryButton = cva("base-classes", {
  variants: { size: { sm: "text-sm", md: "text-base" } }
}); // Duplicate code

const dangerButton = cva("base-classes", {
  variants: { size: { sm: "text-sm", md: "text-base" } }
}); // More duplicate code
```

**CLS (With Inheritance):**
```typescript
// Base button with common functionality
const BaseButtonCls = cls({
  slot: ["root"],
  variant: { size: ["sm", "md", "lg"] }
}, ({ what, def }) => ({
  token: def.token({
    "spacing.sm": ["px-3 py-1.5"],
    "spacing.md": ["px-4 py-2"],
    "spacing.lg": ["px-6 py-3"]
  }),
  rules: [
    def.rule({
      variant: { size: "sm" },
      root: what.css(["text-sm", "spacing.sm"])
    }),
    def.rule({
      variant: { size: "md" },
      root: what.css(["text-base", "spacing.md"])
    }),
    def.rule({
      variant: { size: "lg" },
      root: what.css(["text-lg", "spacing.lg"])
    })
  ]
}));

// Inherit and extend
const PrimaryButtonCls = BaseButtonCls.extend({
  variant: { tone: ["primary"] }
}, ({ what, def }) => ({
  token: def.token({
    "color.bg.primary": ["bg-blue-600"],
    "color.text.primary": ["text-white"]
  }),
  rules: [
    def.rule({
      variant: { tone: "primary" },
      root: what.css(["color.bg.primary", "color.text.primary"])
    })
  ]
}));

const DangerButtonCls = BaseButtonCls.extend({
  variant: { tone: ["danger"] }
}, ({ what, def }) => ({
  token: def.token({
    "color.bg.danger": ["bg-red-600"],
    "color.text.danger": ["text-white"]
  }),
  rules: [
    def.rule({
      variant: { tone: "danger" },
      root: what.css(["color.bg.danger", "color.text.danger"])
    })
  ]
}));
```

## **Advanced Migration Patterns** üöÄ

### **Pattern 1: Runtime Overrides** ‚ö°

**CVA (Static Only):**
```typescript
const button = cva("base-classes", {
  variants: {
    tone: {
      primary: "bg-blue-600 text-white",
      secondary: "bg-gray-600 text-white"
    }
  }
});

// Can't change colors at runtime
function Button({ tone, ...props }) {
  return <button className={button({ tone })} {...props} />;
}
```

**CLS (Runtime Flexibility):**
```typescript
const ButtonCls = cls({
  slot: ["root"],
  variant: { tone: ["primary", "secondary"] }
}, ({ what, def }) => ({
  token: def.token({
    "color.bg.primary": ["bg-blue-600"],
    "color.bg.secondary": ["bg-gray-600"]
  }),
  rules: [
    def.rule({
      variant: { tone: "primary" },
      root: what.css(["color.bg.primary"])
    }),
    def.rule({
      variant: { tone: "secondary" },
      root: what.css(["color.bg.secondary"])
    })
  ]
}));

// Runtime override for dark theme
function Button({ tone, isDarkTheme, ...props }) {
  const buttonClasses = useCls(ButtonCls, ({ what, override }) => ({
    variant: what.variant({ tone }),
    token: override.token({
      "color.bg.primary": isDarkTheme ? ["bg-blue-800"] : ["bg-blue-600"]
    })
  }));

  return (
    <button className={buttonClasses.root()} {...props} />
  );
}
```

### **Pattern 2: Composition** üîó

**CVA (Limited Composition):**
```typescript
// CVA doesn't have built-in composition
const baseButton = cva("base-classes");
const primaryButton = cva("base-classes primary-styles");
const dangerButton = cva("base-classes danger-styles");
```

**CLS (Powerful Composition):**
```typescript
// Compose multiple CLS instances
const BaseButtonCls = cls({ slot: ["root"] }, ({ what, def }) => ({
  rules: [def.root({ root: what.css(["base-button-styles"]) })]
}));

const PrimaryStylesCls = cls({ slot: ["root"] }, ({ what, def }) => ({
  rules: [def.root({ root: what.css(["primary-styles"]) })]
}));

const DangerStylesCls = cls({ slot: ["root"] }, ({ what, def }) => ({
  rules: [def.root({ root: what.css(["danger-styles"]) })]
}));

// Compose them together
const PrimaryButtonCls = BaseButtonCls.use(PrimaryStylesCls);
const DangerButtonCls = BaseButtonCls.use(DangerStylesCls);
```

## **Common Pitfalls & Solutions** ‚ö†Ô∏è

### **Pitfall 1: Forgetting to Import CLS** üì¶

**Problem:**
```typescript
// Missing imports
const ButtonCls = cls({...}); // Error: cls is not defined
```

**Solution:**
```typescript
import { cls } from "@use-pico/cls";
import { useCls } from "@use-pico/cls/react";
import type { Component } from "@use-pico/cls";
```

### **Pitfall 2: Incorrect Contract Structure** üìã

**Problem:**
```typescript
// Wrong: mixing CVA and CLS patterns
const ButtonCls = cls({
  variants: { // Should be 'variant' (singular)
    size: ["sm", "md", "lg"]
  }
}, ({ what, def }) => ({
  // ...
}));
```

**Solution:**
```typescript
// Correct: CLS contract structure
const ButtonCls = cls({
  slot: ["root"],
  variant: { // Singular 'variant'
    size: ["sm", "md", "lg"]
  }
}, ({ what, def }) => ({
  // ...
}));
```

### **Pitfall 3: Missing Design Tokens** üé®

**Problem:**
```typescript
// Hardcoded values in rules
def.rule({
  variant: { tone: "primary" },
  root: what.css(["bg-blue-600", "text-white"]) // Hardcoded
})
```

**Solution:**
```typescript
// Use design tokens
token: def.token({
  "color.bg.primary": ["bg-blue-600"],
  "color.text.primary": ["text-white"]
}),
rules: [
  def.rule({
    variant: { tone: "primary" },
    root: what.css(["color.bg.primary", "color.text.primary"]) // Use tokens
  })
]
```

### **Pitfall 4: Incorrect Component Interface** üß©

**Problem:**
```typescript
// Wrong: mixing CVA and CLS patterns
interface ButtonProps extends VariantProps<typeof ButtonCls> {
  // Error: VariantProps is CVA-specific
}
```

**Solution:**
```typescript
// Correct: CLS component interface
import type { Component } from "@use-pico/cls";

interface ButtonProps extends Component<typeof ButtonCls, React.ButtonHTMLAttributes<HTMLButtonElement>> {
  children: React.ReactNode;
}
```

## **Testing Your Migration** üß™

### **Unit Tests** ‚úÖ

```typescript
import { render, screen } from "@testing-library/react";
import { Button } from "./Button";

describe("Button Migration", () => {
  it("should render with correct CVA-equivalent classes", () => {
    render(<Button size="sm" tone="primary">Click me</Button>);
    
    const button = screen.getByRole("button");
    expect(button).toHaveClass("text-sm", "px-3", "py-1.5", "bg-blue-600", "text-white");
  });

  it("should handle default variants", () => {
    render(<Button>Click me</Button>);
    
    const button = screen.getByRole("button");
    expect(button).toHaveClass("text-base", "px-4", "py-2", "bg-blue-600", "text-white");
  });

  it("should handle user configuration", () => {
    render(
      <Button 
        size="sm" 
        tone="primary"
        tweak={({ what }) => ({
          variant: what.variant({ size: "lg" }) // Override size
        })}
      >
        Click me
      </Button>
    );
    
    const button = screen.getByRole("button");
    expect(button).toHaveClass("text-lg"); // Should use overridden size
  });
});
```

### **Integration Tests** üîó

```typescript
describe("Button Integration", () => {
  it("should work with form submission", () => {
    const handleSubmit = jest.fn();
    
    render(
      <form onSubmit={handleSubmit}>
        <Button type="submit" size="md" tone="primary">
          Submit
        </Button>
      </form>
    );
    
    const button = screen.getByRole("button");
    button.click();
    
    expect(handleSubmit).toHaveBeenCalled();
  });

  it("should handle disabled state", () => {
    render(<Button disabled size="md" tone="primary">Click me</Button>);
    
    const button = screen.getByRole("button");
    expect(button).toBeDisabled();
    expect(button).toHaveClass("opacity-50", "cursor-not-allowed");
  });
});
```

## **Performance Considerations** ‚ö°

### **Bundle Size** üì¶

- **CVA**: ~3KB
- **CLS**: ~15KB
- **Trade-off**: More features for slightly larger bundle

### **Runtime Performance** üèÉ‚Äç‚ôÇÔ∏è

- **CVA**: Fast class generation
- **CLS**: Fast class generation with memoization
- **CLS Advantage**: Per-slot caching prevents redundant computation

### **Tree Shaking** üå≥

Both CVA and CLS support tree shaking, but CLS provides better optimization for unused variants and tokens.

## **Migration Checklist** ‚úÖ

- [ ] **Install CLS** and remove CVA dependency
- [ ] **Convert CVA variants** to CLS contract structure
- [ ] **Extract design tokens** from hardcoded values
- [ ] **Convert variants** to CLS rules
- [ ] **Update component interfaces** to use `Component<T>`
- [ ] **Replace CVA calls** with `useCls()` hook
- [ ] **Implement inheritance** for common patterns
- [ ] **Add runtime overrides** where needed
- [ ] **Update tests** to work with CLS
- [ ] **Test all variant combinations** work correctly
- [ ] **Document new patterns** for team
- [ ] **Remove CVA imports** and references

## **Next Steps** üöÄ

After completing your CVA to CLS migration:

1. **Explore inheritance patterns** for better code organization
2. **Implement design tokens** for consistent theming
3. **Add runtime overrides** for dynamic theming
4. **Optimize performance** with composition and caching
5. **Share patterns** with your team

**Ready to migrate?** Start with a simple component and gradually work your way up to more complex ones! üéØ

---

**Previous:** [14.1 Migration Overview](./14.1-migration-overview.md) | **Next:** [14.3 From TV to CLS](./14.3-from-tv-to-cls.md)
